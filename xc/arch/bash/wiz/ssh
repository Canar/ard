# .bash_profile

# Get the aliases and functions
if [ -f ~/.bashrc ]; then
	. ~/.bashrc
fi

# User specific  environment and startup programs

PATH=$PATH:$HOME/.local/bin:$HOME/bin

export PATH

get_free_port(){
	read low high < /proc/sys/net/ipv4/ip_local_port_range
	port=`shuf -i $low-$high -n 1`
	cat /proc/sys/net/tcp | cut -d: -f3 | cut -d" " -f1 | sort | xargs -I a printf '%d ' 0xa | grep -v $port
	result=${PIPESTATUS[5]}
	if [ $result -ne 0 ] ; then
		get_free_port
	else
		echo $port
	fi
}

assh(){
	autossh -M `get_free_port` -t $1 "screen -DrU"
	result=$?
	if [ $err -ne 0 ] ; then echo "ERROR: $err" ; fi
}

ensure_keys(){
	if [ -f .ssh/id_edcsa ] ; then
		ssh-keygen -t edcsa
	fi
}

GATEWAY=ennorath.ca
register(){
	ensure_keys
	scp -qr ~/.ssh $GATEWAY:/srv/ssh/$HOSTNAME
	sserve & 
}

sserve(){
	ssh -g -N -T -R "*:0:localhost:22" $GATEWAY 2>&1 | while read line ; do
		parse_alloc $line
	done
	sserve
}
	
  	
parse_alloc(){
	echo "$HOSTNAME $3 $!" >> map
	tail -1 map > cmap
	scp cmap ennorath.ca:/srv/ssh/$HOSTNAME
}
